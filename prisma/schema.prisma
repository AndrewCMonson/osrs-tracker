generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String              @id @default(cuid())
  email            String              @unique
  name             String?
  password         String
  createdAt        DateTime            @default(now())
  players          Player[]
  verifications    ClaimVerification[]
}

model Player {
  id           String           @id @default(cuid())
  username     String           @unique
  displayName  String?
  accountType  String           @default("normal")
  totalLevel   Int
  totalXp      BigInt
  combatLevel  Int              @default(3)
  claimedById  String?
  claimedBy    User?            @relation(fields: [claimedById], references: [id])
  skills       Skill[]
  bossKCs      BossKC[]
  snapshots    PlayerSnapshot[]
  milestones   Milestone[]
  nameChanges  PlayerNameChange[] @relation("FromPlayer")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([username])
}

model Skill {
  id       String @id @default(cuid())
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId String
  name     String
  level    Int
  xp       BigInt
  rank     Int    @default(0)

  @@unique([playerId, name])
  @@index([playerId])
}

model BossKC {
  id       String @id @default(cuid())
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId String
  bossName String
  kc       Int
  rank     Int    @default(0)

  @@unique([playerId, bossName])
  @@index([playerId])
}

model PlayerSnapshot {
  id          String         @id @default(cuid())
  player      Player         @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId    String
  totalLevel  Int
  totalXp     BigInt
  combatLevel Int
  skills      SkillSnapshot[]
  bosses      BossSnapshot[]
  createdAt   DateTime       @default(now())

  @@index([playerId, createdAt])
  @@index([playerId])
}

model SkillSnapshot {
  id         String         @id @default(cuid())
  snapshot   PlayerSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  snapshotId String
  name       String
  level      Int
  xp         BigInt
  rank       Int            @default(0)

  @@unique([snapshotId, name])
  @@index([snapshotId])
}

model BossSnapshot {
  id         String         @id @default(cuid())
  snapshot   PlayerSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  snapshotId String
  bossName   String
  kc         Int
  rank       Int            @default(0)

  @@unique([snapshotId, bossName])
  @@index([snapshotId])
}

model Milestone {
  id        String   @id @default(cuid())
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  String
  type      String
  details   String
  achieved  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([playerId])
}

model PlayerNameChange {
  id          String   @id @default(cuid())
  player      Player   @relation("FromPlayer", fields: [playerId], references: [id], onDelete: Cascade)
  playerId    String
  oldUsername String
  newUsername String
  validated   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([playerId])
  @@index([oldUsername])
  @@index([newUsername])
  @@unique([oldUsername, newUsername])
}

model ClaimVerification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  username  String
  token     String   @unique
  status    String   @default("pending") // pending, verified, expired, failed
  createdAt DateTime @default(now())
  expiresAt DateTime
  verifiedAt DateTime?

  @@index([username])
  @@index([token])
  @@index([userId])
  @@index([status])
}
